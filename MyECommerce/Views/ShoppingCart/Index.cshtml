@model List<MyECommerce.Models.ShoppingCartItem>

@{
    ViewData["Title"] = "Shopping Cart";
}


<!-- Breadcrumb -->
<div class="breadcrumb-section pt-40 pb-40">
    <div class="container-1700">
        <p class="breadcrumb-text mb-0">
            <a asp-controller="Home" asp-action="Index">Home</a> / <span class="text-main-color">Cart</span>
        </p>
    </div>
</div>

<!-- Cart Table -->
<div class="ptb-120 bg-white">
    <div class="container">
        <div class="cart-table-wrapper table-responsive">
            @if (Model.Any())
            {
                <table class="cart-table table">
                    <tr>
                        <th class="text-center">Products</th>
                        <th>Price</th>
                        <th>Quantity</th>
                        <th class="text-end">Subtotal</th>
                    </tr>

                    @foreach (var item in Model)
                    {
                        <tr data-product-id="@item.ProductId">
                            <td>
                                <div class="d-flex align-items-center gap-4 product-box">
                                    <button type="button" class="remove_product" data-product-id="@item.ProductId">
                                        <i class="fas fa-close"></i>
                                    </button>
                                    <div class="feature-image light-bg">
                                        <img src="@item.ImageUrl" class="img-fluid" alt="@item.Name">
                                    </div>
                                    <div>
                                        <span class="fs-sm text-uppercase secondary-text-color d-block">@item.Name</span>
                                        <a href="#" class="product-title h6 mt-2 d-block">@item.Name</a>
                                    </div>
                                </div>
                            </td>
                            <td><span class="fw-medium text-main-color">$@item.Price.ToString("F2")</span></td>
                            <td>
                                <div class="quantity d-flex align-items-center">
                                    <input type="number" class="quantity-input" value="@item.Quantity" min="1">
                                    <div class="step-btns">
                                        <button class="increment" data-product-id="@item.ProductId">
                                            <i class="fa-solid fa-angle-up"></i>
                                        </button>
                                        <button class="decrement" data-product-id="@item.ProductId">
                                            <i class="fa-solid fa-angle-down"></i>
                                        </button>
                                    </div>
                                </div>
                            </td>
                            <td><span class="text-main-color fw-medium d-block text-end subtotal">$@((item.Price * item.Quantity).ToString("F2"))</span></td>
                        </tr>

                    }

                    <tr>
                        <td colspan="4">
                            <div class="d-flex align-items-center justify-content-between gap-4 flex-wrap">
                                <form class="cart-coupon-form d-flex align-items-center">
                                    <input type="text" placeholder="Coupon Code" class="theme-input">
                                    <button type="submit" class="submit-btn template-btn primary-btn">Apply Coupon</button>
                                </form>
                                <button type="button" class="template-btn primary-btn"><span>Update Cart</span></button>
                            </div>
                        </td>
                    </tr>
                </table>
            }
            else
            {
                <p class="text-center">Your cart is empty.</p>
            }
        </div>
    </div>
</div>

<!-- Cart Totals -->
<section class="pb-140 bg-white">
    <div class="container">
        <div class="row">
            <div class="col-xl-6">
                <div class="cart-calculator">
                    <h3 class="mb-40">Cart Totals</h3>
                    <form class="cart-calculator-form">
                        <table class="table">
                            <tr>
                                <td>Subtotal</td>
                                <td id="cart-subtotal">$@Model.Sum(item => item.Price * item.Quantity).ToString("F2")</td>
                            </tr>
@*                             <tr>
                                <td>Total</td>
                                <td id="cart-total">$@Model.Sum(item => item.Price * item.Quantity).ToString("F2")</td>
                            </tr> *@
                        </table>
                        <a asp-controller="Order" asp-action="Checkout" class="template-btn primary-btn text-uppercase mt-5">
                            <span>Proceed to Checkout</span>
                        </a>
                    </form>
                </div>
            </div>
        </div>
    </div>
</section>

<!--hm2 feature section start-->
<section class="hm2-feature-section overflow-hidden light-bg-2 border-0">
    <div class="container-1400">
        <div class="row align-items-center g-5">
            <div class="col-xl-3 col-lg-4 col-sm-6">
                <div class="hm2-feature-box">
                    <span class="icon-wrapper d-inline-flex align-items-center justify-content-center rounded-circle">
                        <img src="~/assets/images/icons/1.svg" alt="not found" class="img-fluid">
                    </span>
                    <h6 class="fw-normal hm2-font-family mt-40 mb-4">Free Delivery</h6>
                    <p class="mb-0">Orci lectus per torquent netusque habitasse mauris inceptos.</p>
                </div>
            </div>
            <div class="col-xl-3 col-lg-4 col-sm-6">
                <div class="hm2-feature-box">
                    <span class="icon-wrapper d-inline-flex align-items-center justify-content-center rounded-circle">
                        <img src="~/assets/images/icons/2.svg" alt="not found" class="img-fluid">
                    </span>
                    <h6 class="fw-normal hm2-font-family mt-40 mb-4">90 Days Returns</h6>
                    <p class="mb-0">Orci lectus per torquent netusque habitasse mauris inceptos.</p>
                </div>
            </div>
            <div class="col-xl-3 col-lg-4 col-sm-6">
                <div class="hm2-feature-box">
                    <span class="icon-wrapper d-inline-flex align-items-center justify-content-center rounded-circle">
                        <img src="~/assets/images/icons/3.svg" alt="not found" class="img-fluid">
                    </span>
                    <h6 class="fw-normal hm2-font-family mt-40 mb-4">Secure Payment</h6>
                    <p class="mb-0">Orci lectus per torquent netusque habitasse mauris inceptos.</p>
                </div>
            </div>
            <div class="col-xl-3 col-lg-4 col-sm-6">
                <div class="hm2-feature-box">
                    <span class="icon-wrapper d-inline-flex align-items-center justify-content-center rounded-circle">
                        <img src="~/assets/images/icons/4.svg" alt="not found" class="img-fluid">
                    </span>
                    <h6 class="fw-normal hm2-font-family mt-40 mb-4">100% Free Warranty</h6>
                    <p class="mb-0">Orci lectus per torquent netusque habitasse mauris inceptos.</p>
                </div>
            </div>
        </div>
    </div>
</section>

<script>

$(document).ready(function () { 
    // ✅ Remove item from cart


    // ✅ Update quantity (Increase)



        // ✅ Increase quantity
        $(document).on("click", ".increment", function () {
        let productId = $(this).data("product-id");
        let input = $(this).closest(".quantity").find(".quantity-input");
        let newQuantity = parseInt(input.val()) + 1;

        updateQuantity(productId, newQuantity, input);
    });

    $(document).on("click", ".decrement", function () {
        let productId = $(this).data("product-id");
        let input = $(this).closest(".quantity").find(".quantity-input");
        let newQuantity = Math.max(1, parseInt(input.val()) - 1);

        updateQuantity(productId, newQuantity, input);
    });


    $(document).on("click", ".remove_product, .remove-from-cart", function () {
        var productId = $(this).data("product-id");
        var row = $(`tr[data-product-id="${productId}"], li[data-product-id="${productId}"]`);

        $.post("/ShoppingCart/RemoveFromCart", { productId: productId }, function (response) {
            if (response.success) {
                row.fadeOut(500, function () {
                    $(this).remove();
                    updateCart(response); // ✅ Update Cart Drawer Instantly
                });
            } else {
                alert(response.message);
            }
        }).fail(function () {
            alert("Error removing product from cart. Please try again!");
        });
    });


        // ✅ Function to update quantity
function updateQuantity(productId, quantity, inputField) {
    $.post("/ShoppingCart/UpdateQuantity", { id: productId, quantity: quantity }, function (response) { // ✅ Fix parameter name
        if (response.success) {
            inputField.val(quantity);

            let row = inputField.closest("tr");
            let price = parseFloat(row.find(".fw-medium.text-main-color").text().replace("$", ""));
            let subtotal = (price * quantity).toFixed(2);
            row.find(".subtotal").text("$" + subtotal);

            updateCart(response); // ✅ Update Cart Drawer Instantly
        } else {
            alert(response.message);
        }
    }).fail(function () {
        alert("Error updating quantity. Please try again!");
    });
}




        // ✅ Function to update cart total
       function updateCart(cartData) {
        if (!cartData || !cartData.cartItems) {
            console.error("Invalid cart data:", cartData);
            return;
        }

        let totalPrice = cartData.totalPrice ?? 0;
        let totalItems = cartData.cartItems.reduce((sum, item) => sum + item.quantity, 0);

        // ✅ Update Cart Subtotal & Total in Main Cart Section
        $("#cart-total").text("$" + totalPrice.toFixed(2));
        $("#cart-subtotal").text("$" + totalPrice.toFixed(2));

        // ✅ Update Cart Count in Header
        $(".cart-item").text(totalItems);
        $(".cart-amount").text("$" + totalPrice.toFixed(2));

        // ✅ Ensure Cart Drawer is Reset Properly
        let cartList = $(".cart-list");
        cartList.empty(); // ✅ Clear cart before adding new items

        cartData.cartItems.forEach(item => {
            let itemPrice = item.price ?? 0;
            let subtotal = (itemPrice * item.quantity).toFixed(2);

            let cartItemHTML = `
                <li class="d-flex align-items-center gap-4 flex-wrap flex-sm-nowrap cart-item-container" data-product-id="${item.id}">
                    <div class="feature-image light-bg">
                        <img src="${item.imageUrl}" alt="${item.name}" class="cart-item-img img-fluid">
                    </div>
                    <div class="d-flex justify-content-between gap-3 w-100">
                        <div>
                            <a href="#"><h6 class="mb-1">${item.name}</h6></a>
                            <span class="price fw-medium secondary-text-color d-block mb-1 fs-sm">$${subtotal}</span>
                            <div class="quantity d-flex align-items-center">
                                <input type="text" value="${item.quantity}" readonly>
                                <div class="step-btns">
                                    <button class="increment" data-id="${item.id}"><i class="fa-solid fa-angle-up"></i></button>
                                    <button class="decrement" data-id="${item.id}"><i class="fa-solid fa-angle-down"></i></button>
                                </div>
                            </div>
                        </div>
                        <div>
                            <a href="javascript:void(0)" class="close remove-item" data-id="${item.id}"><i class="fas fa-xmark"></i></a>
                        </div>
                    </div>
                </li>
            `;
            cartList.append(cartItemHTML); // ✅ Ensure consistent structure
        });

        // ✅ Reapply styles after updating cart drawer
        applyCartDrawerStyles();
    }

        function applyCartDrawerStyles() {
        $(".cart-item-img").css({
            "width": "50px",  // ✅ Keep image size fixed
            "height": "auto",
            "object-fit": "cover"
        });

        $(".cart-list li").css({
            "display": "flex",
            "align-items": "center",
            "justify-content": "space-between"
        });

        console.log("Cart styles reapplied!"); // ✅ Debugging (Check in console)
    }



});
</script>


<style>
    /* Hide number input spinners in Chrome, Safari, Edge */
    .quantity-input::-webkit-outer-spin-button,
    .quantity-input::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    /* Hide number input arrows in Firefox */
    .quantity-input {
        -moz-appearance: textfield;
    }



</style>
