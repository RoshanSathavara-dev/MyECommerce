@model MyECommerce.Models.Product

@{
    ViewData["Title"] = "Product Details";
}

<h2>@Model.Name</h2>

<div class="card">
    <img src="@Model.ImageUrl" alt="@Model.Name" class="card-img-top" style="max-width:300px;" />
    <div class="card-body">
        <h4 class="card-title">@Model.Name</h4>
        <p class="card-text">@Model.Description</p>
        <h5 class="text-success">Price: $@Model.Price</h5>
        <p><strong>Category:</strong> @Model.Category?.Name</p>
        <p><strong>Stock:</strong> @Model.Stock</p>
        <a asp-controller="Home" asp-action="Index" class="btn btn-primary">Back to Home</a>


        <form asp-controller="ShoppingCart" asp-action="AddToCart" method="post" class="mt-3">
            <input type="hidden" name="productId" value="@Model.Id" />
            <div class="input-group" style="max-width: 200px;">
                <input type="number" name="quantity" value="1" min="1" class="form-control" />
                <button type="submit" class="btn btn-success">Add to Cart</button>
            </div>
        </form>

        <h4>Customer Reviews</h4>
        <div id="review-list"></div>

        @if (Context.Session.GetInt32("UserId") != null)
        {
            <h5>Add Your Review</h5>
            <div>
                <label>Rating:</label>
                <div class="rating">
                    <input type="radio" name="rating" value="5" id="star5"><label for="star5">★</label>
                    <input type="radio" name="rating" value="4" id="star4"><label for="star4">★</label>
                    <input type="radio" name="rating" value="3" id="star3"><label for="star3">★</label>
                    <input type="radio" name="rating" value="2" id="star2"><label for="star2">★</label>
                    <input type="radio" name="rating" value="1" id="star1"><label for="star1">★</label>
                </div>

                <label>Comment:</label>
                <textarea id="comment" class="form-control"></textarea>

                <button class="btn btn-success mt-2" onclick="submitReview()">Submit Review</button>
            </div>
        }
        else
        {
            <p><a href="/Account/Login">Login</a> to submit a review.</p>
        }


  
    </div>
</div>


                    <script>
    function loadReviews() {
        $.get("/Review/GetReviews?productId=@Model.Id", function (data) {
            var reviewsHtml = "";
            if (data.length === 0) {
                reviewsHtml = "<p>No reviews yet.</p>";
            } else {
                data.forEach(function (review) {
                    reviewsHtml += `
                        <div class="review-item">
                            <strong>${review.name}</strong> 
                            <span>(${review.rating} ★)</span>
                            <p>${review.comment}</p>
                            <small>${review.createdAt}</small>
                        </div>
                        <hr>`;
                });
            }
            $("#review-list").html(reviewsHtml);
        });
    }

    function submitReview() {
        var rating = $("input[name='rating']:checked").val();
        var comment = $("#comment").val();

        if (!rating) {
            alert("Please select a rating.");
            return;
        }

            $.post("/Review/AddReview", {
        productId: productId, // ✅ Now productId is properly defined
        rating: rating,
        comment: comment
    }, function (response) {
        alert(response.message);
        if (response.success) {
            loadReviews();
            $("#comment").val(""); // Clear the comment box
        }
    });

    }

    $(document).ready(function () {
        loadReviews();
    });
    $(document).ready(function () {
        $.get("/Review/CheckLoginStatus", function (data) {
            console.log("UserId in Session:", data.userId);
        });
    });

</script>

<!-- CSS for star rating -->
<style>
    .rating {
        direction: rtl;
        unicode-bidi: bidi-override;
        text-align: left;
    }
    .rating input {
        display: none;
    }
    .rating label {
        font-size: 24px;
        color: gray;
        cursor: pointer;
    }
    .rating input:checked ~ label {
        color: gold;
    }
</style>